#!/bin/bash

# AWS Service Catalog EC2 Product Setup Script
# This script creates the Service Catalog portfolio, product, and permissions
# Usage: ./setup-service-catalog.sh

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration variables
PORTFOLIO_NAME="${1:-Infrastructure Services}"
PRODUCT_NAME="${2:-EC2 with Monitoring}"
PRODUCT_DESCRIPTION="Production-grade EC2 instance with CloudWatch monitoring, alarms, and SNS notifications"
TEMPLATE_BUCKET="${3:-my-org-sc-templates-$(date +%s)}"
REGION="${AWS_REGION:-us-east-1}"
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

echo -e "${YELLOW}========================================${NC}"
echo -e "${YELLOW}AWS Service Catalog EC2 Product Setup${NC}"
echo -e "${YELLOW}========================================${NC}\n"

# Step 1: Create S3 bucket for CloudFormation template
echo -e "${YELLOW}Step 1: Creating S3 bucket for templates...${NC}"
if aws s3 ls "s3://${TEMPLATE_BUCKET}" 2>/dev/null; then
    echo -e "${GREEN}âœ“ Bucket already exists: ${TEMPLATE_BUCKET}${NC}"
else
    aws s3 mb "s3://${TEMPLATE_BUCKET}" --region "${REGION}"
    echo -e "${GREEN}âœ“ Created S3 bucket: ${TEMPLATE_BUCKET}${NC}"
fi

# Enable versioning
aws s3api put-bucket-versioning \
    --bucket "${TEMPLATE_BUCKET}" \
    --versioning-configuration Status=Enabled
echo -e "${GREEN}âœ“ Enabled versioning on bucket${NC}"

# Step 2: Upload CloudFormation template
echo -e "\n${YELLOW}Step 2: Uploading CloudFormation template...${NC}"
TEMPLATE_KEY="ec2-with-monitoring/v1.0.yaml"
TEMPLATE_URL="https://${TEMPLATE_BUCKET}.s3.${REGION}.amazonaws.com/${TEMPLATE_KEY}"

# Save template to temp file if not exists
if [ ! -f "ec2-product-template.yaml" ]; then
    echo -e "${RED}Warning: ec2-product-template.yaml not found in current directory${NC}"
    echo "Please ensure the CloudFormation template file exists"
    exit 1
fi

aws s3 cp ec2-product-template.yaml "s3://${TEMPLATE_BUCKET}/${TEMPLATE_KEY}"
echo -e "${GREEN}âœ“ Template uploaded to: ${TEMPLATE_URL}${NC}"

# Step 3: Create Service Catalog Portfolio
echo -e "\n${YELLOW}Step 3: Creating Service Catalog Portfolio...${NC}"

PORTFOLIO_ID=$(aws servicecatalog create-portfolio \
    --display-name "${PORTFOLIO_NAME}" \
    --description "Portfolio for infrastructure services including EC2 with monitoring" \
    --region "${REGION}" \
    --query 'PortfolioDetail.Id' \
    --output text)

echo -e "${GREEN}âœ“ Portfolio created: ${PORTFOLIO_ID}${NC}"

# Step 4: Create Service Catalog Product
echo -e "\n${YELLOW}Step 4: Creating Service Catalog Product...${NC}"

PRODUCT_ID=$(aws servicecatalog create-product \
    --name "${PRODUCT_NAME}" \
    --description "${PRODUCT_DESCRIPTION}" \
    --product-type CLOUD_FORMATION_TEMPLATE \
    --provisioning-artifact-parameters \
    TemplateUrl="${TEMPLATE_URL}" \
    --region "${REGION}" \
    --query 'ProductViewDetail.ProductViewSummary.ProductId' \
    --output text)

echo -e "${GREEN}âœ“ Product created: ${PRODUCT_ID}${NC}"

# Step 5: Associate product with portfolio
echo -e "\n${YELLOW}Step 5: Associating product with portfolio...${NC}"

aws servicecatalog associate-product-with-portfolio \
    --product-id "${PRODUCT_ID}" \
    --portfolio-id "${PORTFOLIO_ID}" \
    --region "${REGION}"

echo -e "${GREEN}âœ“ Product associated with portfolio${NC}"

# Step 6: Create SNS Topic for notifications
echo -e "\n${YELLOW}Step 6: Creating SNS Topic for notifications...${NC}"

SNS_TOPIC_NAME="sc-ec2-alarms-${ACCOUNT_ID}"
SNS_TOPIC_ARN=$(aws sns create-topic \
    --name "${SNS_TOPIC_NAME}" \
    --region "${REGION}" \
    --query 'TopicArn' \
    --output text)

echo -e "${GREEN}âœ“ SNS Topic created: ${SNS_TOPIC_ARN}${NC}"

# Step 7: Create SNS subscription template (needs user email)
echo -e "\n${YELLOW}Step 7: SNS Subscription${NC}"
echo -e "${YELLOW}To receive notifications, subscribe to the SNS topic:${NC}"
echo -e "${YELLOW}aws sns subscribe --topic-arn ${SNS_TOPIC_ARN} --protocol email --notification-endpoint YOUR-EMAIL@company.com${NC}\n"

# Step 8: Create tagging constraints
echo -e "${YELLOW}Step 8: Adding tagging constraint...${NC}"

aws servicecatalog create-constraint \
    --portfolio-id "${PORTFOLIO_ID}" \
    --product-id "${PRODUCT_ID}" \
    --type TAG_UPDATE \
    --parameters '[{"Key":"TagUpdatesOnProvisionedProduct","Value":"ALLOWED"}]' \
    --region "${REGION}" || echo "Tagging constraint may already exist"

echo -e "${GREEN}âœ“ Tagging constraint added${NC}"

# Step 9: Create launch constraint with IAM role
echo -e "\n${YELLOW}Step 9: Creating launch constraint...${NC}"

# Create IAM role for Service Catalog launch
LAUNCH_ROLE_NAME="ServiceCatalogLaunchRole-EC2"

# Check if role already exists
if aws iam get-role --role-name "${LAUNCH_ROLE_NAME}" 2>/dev/null; then
    echo -e "${GREEN}âœ“ Launch role already exists${NC}"
    LAUNCH_ROLE_ARN=$(aws iam get-role --role-name "${LAUNCH_ROLE_NAME}" --query 'Role.Arn' --output text)
else
    # Create the role
    TRUST_POLICY=$(cat <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "servicecatalog.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF
)

    LAUNCH_ROLE_ARN=$(aws iam create-role \
        --role-name "${LAUNCH_ROLE_NAME}" \
        --assume-role-policy-document "${TRUST_POLICY}" \
        --query 'Role.Arn' \
        --output text)

    echo -e "${GREEN}âœ“ Launch role created: ${LAUNCH_ROLE_ARN}${NC}"

    # Attach policy for CloudFormation
    aws iam attach-role-policy \
        --role-name "${LAUNCH_ROLE_NAME}" \
        --policy-arn arn:aws:iam::aws:policy/PowerUserAccess

    # Add policy for SNS
    SNS_POLICY=$(cat <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "sns:*",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:*",
        "logs:*",
        "ec2:*",
        "iam:*"
      ],
      "Resource": "*"
    }
  ]
}
EOF
)

    aws iam put-role-policy \
        --role-name "${LAUNCH_ROLE_NAME}" \
        --policy-name ServiceCatalogEC2Policy \
        --policy-document "${SNS_POLICY}"

    echo -e "${GREEN}âœ“ Policies attached to launch role${NC}"
fi

# Create launch constraint
CONSTRAINT_ID=$(aws servicecatalog create-constraint \
    --portfolio-id "${PORTFOLIO_ID}" \
    --product-id "${PRODUCT_ID}" \
    --type LAUNCH \
    --parameters "{\"RoleArn\":\"${LAUNCH_ROLE_ARN}\"}" \
    --region "${REGION}" \
    --query 'ConstraintDetail.ConstraintId' \
    --output text)

echo -e "${GREEN}âœ“ Launch constraint created: ${CONSTRAINT_ID}${NC}"

# Step 10: Output summary
echo -e "\n${GREEN}========================================${NC}"
echo -e "${GREEN}Setup Complete!${NC}"
echo -e "${GREEN}========================================${NC}\n"

cat <<EOF

ðŸ“Š Service Catalog Product Summary:

Portfolio ID:          ${PORTFOLIO_ID}
Product ID:            ${PRODUCT_ID}
Product Name:          ${PRODUCT_NAME}
CloudFormation URL:    ${TEMPLATE_URL}
Launch Role ARN:       ${LAUNCH_ROLE_ARN}
SNS Topic ARN:         ${SNS_TOPIC_ARN}
S3 Bucket:             ${TEMPLATE_BUCKET}
Region:                ${REGION}

ðŸš€ Next Steps:

1. Subscribe to SNS Topic for notifications:
   aws sns subscribe \\
     --topic-arn ${SNS_TOPIC_ARN} \\
     --protocol email \\
     --notification-endpoint YOUR-EMAIL@company.com

2. Grant user access to portfolio:
   aws servicecatalog associate-principal-with-portfolio \\
     --portfolio-id ${PORTFOLIO_ID} \\
     --principal-arn arn:aws:iam::${ACCOUNT_ID}:role/YourRoleName \\
     --principal-type IAM

3. Access Service Catalog in AWS Console:
   https://console.aws.amazon.com/servicecatalog/home?region=${REGION}#/

4. Click "Products" and find "${PRODUCT_NAME}"
   - Click "Launch product"
   - Fill in parameters (VPC, Subnet, Instance Type, etc.)
   - Review and launch

ðŸ“ Important Notes:

â€¢ Remember to update the SNS Topic ARN when launching products
â€¢ Users need appropriate IAM permissions to access the portfolio
â€¢ Ensure VPC/Subnet/Security Group exist before launching
â€¢ CloudWatch metrics will appear after ~1 minute

ðŸ”— AWS Service Catalog Documentation:
https://docs.aws.amazon.com/servicecatalog/latest/adminguide/

EOF

# Create CloudFormation template file reference
echo -e "\n${YELLOW}Saving configuration to file...${NC}"

cat > sc-setup-config.json <<EOF
{
  "portfolio_id": "${PORTFOLIO_ID}",
  "product_id": "${PRODUCT_ID}",
  "sns_topic_arn": "${SNS_TOPIC_ARN}",
  "template_bucket": "${TEMPLATE_BUCKET}",
  "template_url": "${TEMPLATE_URL}",
  "launch_role_arn": "${LAUNCH_ROLE_ARN}",
  "region": "${REGION}",
  "account_id": "${ACCOUNT_ID}",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

echo -e "${GREEN}âœ“ Configuration saved to sc-setup-config.json${NC}"

# Optional: Generate sample launch parameters
echo -e "\n${YELLOW}Step 11: Creating sample parameter files...${NC}"

cat > sample-parameters.json <<'PARAMS'
{
  "Parameters": {
    "InstanceName": "prod-web-server",
    "InstanceType": "t3.medium",
    "EnvironmentTag": "production",
    "CostCenter": "engineering",
    "CpuAlarmThreshold": "80",
    "MemoryAlarmThreshold": "85",
    "DiskAlarmThreshold": "80",
    "EnableAutoRecovery": "true"
  }
}
PARAMS

echo -e "${GREEN}âœ“ Sample parameters file created: sample-parameters.json${NC}"

echo -e "\n${GREEN}========================================${NC}"
echo -e "${GREEN}Setup script completed successfully!${NC}"
echo -e "${GREEN}========================================${NC}\n"
